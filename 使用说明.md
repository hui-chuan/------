# 对排文档换行符清理工具使用说明

## 功能概述

这个工具用于清理对排文档（藏汉对排、汉英对排、藏汉英对排等）中的多余换行符，并检查语言交替顺序的一致性，使文档格式更加整齐。

### 主要功能

1. **换行符清理**：删除多余的换行符，合并同语言内的分行文本
2. **对排一致性检查**：检测语言交替模式，标记不符合模式的错误行
3. **特殊字符保护**：保护单独的问号行和数字"0"行
4. **多格式支持**：支持 txt 和 docx 格式文档

## 安装依赖

```bash
pip install -r requirements.txt
```

## 使用方法

### 1. 处理单个文件
```bash
python document_cleaner.py 文件路径.txt
python document_cleaner.py 文件路径.docx
```

### 2. 处理整个目录
```bash
python document_cleaner.py 目录路径
```

### 3. 跳过对排检查
```bash
python document_cleaner.py 文件路径.txt --no-alignment-check
```

### 4. 查看帮助
```bash
python document_cleaner.py --help
```

## 清理逻辑

### 第1种检查：连续换行符清理
- **逻辑**：如果发现连续的2个或更多换行符，只保留1个
- **效果**：消除文档中的空行，使格式更紧凑
- **示例**：
  ```
  原始：文本1\n\n\n文本2
  清理后：文本1\n文本2
  ```

### 第2种检查：同语言换行符清理
- **逻辑**：分析换行符前后两行的完整内容，如果是同种语言，则删除换行符
- **语言检测**：
  - 藏文：Unicode范围 0x0F00-0x0FFF
  - 汉文：Unicode范围 0x4E00-0x9FFF 等
  - 英文：Unicode范围 0x0041-0x007A 等
  - **忽略标点符号**：只根据文字内容判断语言
  - **多数原则**：混合语言时按占多数的语言判断
- **特殊处理**：
  - 跳过特殊单字符行（"?"、"？"、"0"）的处理
  - 保留对排文档的结构完整性
- **效果**：合并同种语言内被意外分行的文本

### 第3种检查：对排一致性检查
- **逻辑**：分析文档前几行，确定语言交替模式，然后检查后续行是否符合此模式
- **模式检测**：
  - 支持2-4种语言的交替模式
  - 使用容错算法，60%以上匹配率即认为是有效模式
  - 自动跳过特殊行（空行、问号行、"0"行）
- **错误标记**：
  - 不符合模式的行会添加 `{aligned_error}` 标记
  - 保持原文内容不变，只添加标记
- **效果**：帮助发现对排文档中的语言顺序错误

## 清理效果示例

### 原始文档：
```
བཀྲ་ཤིས་
བདེ་ལེགས།


你好
世界！

Hello
World!


这是一段很长的中文文本，
由于排版问题被分成了多行，
但实际上应该是连续的一段话。

This is a long English text that has been
split into multiple lines due to formatting
issues, but should be continuous.
```

### 清理后：
```
བཀྲ་ཤིས་ བདེ་ལེགས།
你好 世界！
Hello World!
这是一段很长的中文文本， 由于排版问题被分成了多行， 但实际上应该是连续的一段话。
This is a long English text that has been split into multiple lines due to formatting issues, but should be continuous.
这是第一行中文
?
这是第二行中文 还有一行中文
？
又是一行中文 这是测试0行的情况
0
继续中文内容
```

## 对排一致性检查示例

### 正常对排文档：
```
བཀྲ་ཤིས་བདེ་ལེགས།
你好世界
Hello world
བོད་ཡིག་གི་ཡི་གེ
中文内容
English content
```

**检测结果：**
- 检测到的语言模式: tibetan → chinese → english (置信度: 100%)
- 无错误标记

### 有错误的对排文档：
```
བཀྲ་ཤིས་བདེ་ལེགས།
你好世界
Hello world
བོད་ཡིག་གི་ཡི་གེ
中文内容
ཕྱི་ལོ་ཉིས་སྟོང་ཉེར་བཞི
错误的中文行
This should be English
```

**检测结果：**
```
བཀྲ་ཤིས་བདེ་ལེགས།
你好世界
Hello world
བོད་ཡིག་གི་ཡི་གེ
中文内容 {aligned_error}
ཕྱི་ལོ་ཉིས་སྟོང་ཉེར་བཞི {aligned_error}
错误的中文行 {aligned_error}
This should be English {aligned_error}
```
- 检测到的语言模式: tibetan → chinese → english (置信度: 72%)
- 发现4个对排错误

### 重要改进说明：

1. **按行分析**：不再使用固定的10个字符窗口，而是分析完整的行内容
2. **忽略标点符号**：语言判断时忽略标点符号，只看文字内容
3. **特殊字符行保护**：包含特殊单字符（"?"、"？"、"0"）的行不会被合并
4. **多数语言原则**：混合语言文本按占多数的语言来判断
5. **对排一致性检查**：新增功能，自动检测语言交替模式并标记错误
6. **容错算法**：使用智能模式检测，能够处理包含少量错误的文档

## 关于第2种检查的建议和讨论

### 当前实现的优点：
1. **精确的语言检测**：使用Unicode范围准确识别藏文、汉文、英文
2. **上下文感知**：检查前后10个字符，而不是单个字符
3. **保留对排结构**：不同语言之间的换行符会被保留
4. **安全性**：只有确定是同种语言时才删除换行符

### 可能的改进方向：

#### 1. 调整检测窗口大小
```python
# 当前：固定10个字符
# 建议：可配置的窗口大小
def should_remove_newline(self, text: str, newline_pos: int, window_size: int = 10):
```

#### 2. 更智能的语言检测
```python
# 考虑标点符号和数字的处理
# 混合语言文本的处理策略
# 语言置信度评估
```

#### 3. 特殊情况处理
- **短行处理**：对于很短的行（如1-2个字符），可能需要特殊处理
- **标点符号**：行尾标点符号的处理
- **数字和符号**：数字、标点符号的语言归属判断

#### 4. 用户自定义规则
```python
# 可以添加用户自定义的清理规则
# 例如：特定词汇前后的换行符处理
# 特定格式的保留（如编号、列表等）
```

### 建议的配置选项：
1. **检测窗口大小**：允许用户调整前后检查的字符数
2. **语言检测严格程度**：设置语言检测的置信度阈值
3. **特殊符号处理**：配置标点符号、数字的语言归属
4. **保留模式**：某些特殊格式的换行符强制保留

## 注意事项

1. 处理后的文件会保存为 `原文件名_cleaned.扩展名`
2. 原文件不会被修改
3. 确保文件编码为UTF-8格式
4. 对于docx文件，需要安装python-docx库

## 测试

运行测试脚本查看清理效果：
```bash
python test_cleaner.py
``` 